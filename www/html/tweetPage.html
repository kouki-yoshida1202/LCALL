<ons-page id="tweetPage">
  <style>
    #tweetFab {
      background-color: #ff9831;
    }

    #tweetModal ons-col {
      padding-top: 5px;
      padding-bottom: 5px;
    }
    #tweetPage p {
      margin-top: 0px;
      margin-bottom: 0px;
    }
  </style>
  <ons-toolbar>
    <div class="left" id="toolbar-title" style="width:10%;"></div>
    <div class="center" id="toolbar-title" style="width:80%;">つぶやき</div>
    <div
      class="right"
      id="toolbar-title"
      onclick="tweetPageChange()"
      style="display:flex;align-items:center;width:10%;"
    >
      <i class="fas fa-exchange-alt fa-fw"></i>
    </div>
  </ons-toolbar>
  <ons-pull-hook id="tweetPagePullHook">
    Pull to refresh
  </ons-pull-hook>
  <ons-fab id="tweetFab" position="bottom right" onclick="tweetModalShow();">
    <ons-icon icon="md-comment"></ons-icon>
  </ons-fab>
  <div>
    <ons-list id="tweetList"> </ons-list>
  </div>
  <ons-modal id="tweetModal" direction="up">
    <ons-card>
      <ons-row>
        <ons-col class="navy-font" vertical-align="center" width="90%">
          ※女性会員ページにのみ表示されます
        </ons-col>
        <ons-col vertical-align="center" style="text-align: right;">
          <i
            class="fas fa-times-circle"
            onclick="tweetModalHide()"
            style="color:gray;"
          ></i>
        </ons-col>
      </ons-row>
      <ons-row>
        <ons-col vertical-align="center">
          <textarea
            id="tweetInputText"
            class="textarea textarea--transparent"
            rows="10"
            placeholder="つぶやきを記入してください(130文字以内)"
            maxlength="130"
          ></textarea>
        </ons-col>
      </ons-row>
      <ons-row>
        <ons-col vertical-align="center">
          <ons-button
            modifier="large"
            class="large-button-orange"
            onclick="tweetInsert()"
            >つぶやく</ons-button
          >
        </ons-col>
      </ons-row>
    </ons-card>
  </ons-modal>
  <input type="hidden" id="nowTweetPageSex" />
  <script>
    setTimeout(function() {
      let tweetPage = document.querySelector("#tweetPage");
      original_main_height = tweetPage.clientHeight;
    }, 100);

    //ソフトウェアキーボード表示処理
    window.addEventListener("keyboardWillShow", event => {
      //画面の高さをキーボードの高さを差し引いた値とする
      $("#tweetPage").animate(
        { height: original_main_height - event.keyboardHeight + "px" },
        100
      );
    });

    //ソフトウェアキーボード非表示処理
    window.addEventListener("keyboardWillHide", () => {
      //画面の高さを元の高さに戻す
      $("#tweetPage").animate({ height: original_main_height + "px" }, 100);
    });
    ons.ready(function() {
      var pullHook = document.getElementById("tweetPagePullHook");
      pullHook.onAction = function(done) {
        tweetGetCheck();
        setTimeout(() => {
          done();
        }, 3000);
      };
      pullHook.addEventListener("changestate", function(event) {
        var message = "";

        switch (event.state) {
          case "initial":
            message = '<i class="fas fa-spinner" style="font-size:1.3em;"></i>';
            break;
          case "preaction":
            message = '<i class="fas fa-spinner" style="font-size:1.3em;"></i>';
            break;
          case "action":
            message =
              '<i class="fas fa-spinner fa-spin" style="font-size:1.3em;"></i>';
            break;
        }

        pullHook.innerHTML = message;
      });
    });

    function tweetPageChange() {
      var nowPage = $("#nowTweetPageSex").val();
      if (nowPage == "man") {
        ons.notification.confirm({
          message: "女性つぶやきページに切り替えますか",
          title: "確認",
          buttonLabels: ["キャンセル", "OK"],
          callback: function(buttonIndex) {
            if (buttonIndex == 1) {
              tweetGet("woman");
            }
          }
        });
      } else {
        ons.notification.confirm({
          message: "男性つぶやきページに切り替えますか",
          title: "確認",
          buttonLabels: ["キャンセル", "OK"],
          callback: function(buttonIndex) {
            if (buttonIndex == 1) {
              tweetGet("man");
            }
          }
        });
      }
    }
    function tweetModalShow() {
      var modal = document.querySelector("#tweetModal");
      modal.show();
    }
    function tweetModalHide() {
      var modal = document.querySelector("#tweetModal");
      modal.hide();
    }
    setTimeout(function() {
      tweetGetCheck();
    }, 500);
    function tweetGetCheck() {
      var user = firebase.auth().currentUser;
      var userId = user.uid;
      db.collection("users")
        .doc(userId)
        .get()
        .then(function(userResult) {
          var sex = userResult.data().sex;
          if (sex == "woman") {
            var userSex = "man";
          } else {
            var userSex = "woman";
          }

          tweetGet(userSex);
        });
    }
    function tweetGet(userSex) {
      $("#tweetList").empty();
      $("#nowTweetPageSex").val(userSex);
      db.collection("tweet")
        .where("userSex", "==", userSex)
        .orderBy("createTime", "desc")
        .limit(20)
        .get()
        .then(function(tweetResults) {
          if (tweetResults.size > 0) {
            var nowDataCount = 0;
            tweetResults.forEach(tweetResult => {
              var tweetlist =
                `
                <ons-list-item id="tweetlist_` +
                nowDataCount +
                `">
                  <div class="left">
                    <img id="tweetImage_` +
                nowDataCount +
                `"class="list-item__thumbnail" src="img/userSampleImageMan.png"
                      style="width:45px;height:45px;border-radius: 50%;object-fit:cover;" />
                  </div>
                  <div class="center">
                    <p id="tweetUserName_` +
                nowDataCount +
                `" class="list-item__title navy-font" style="padding-bottom:5px;"></p>
                    <p id="tweetText_` +
                nowDataCount +
                `" class="tweetText list-item__subtitle light-navy-font"></p>
                    <p id="tweetTime_` +
                nowDataCount +
                `"class="light-navy-font list-item__subtitle" style="text-align:right;">
                    </p>
                  </div>
                </ons-list-item>
              `;
              $("#tweetList").append(tweetlist);
              tweetIndicate(
                tweetResult.data(),
                nowDataCount,
                tweetResults.size
              );
              nowDataCount++;
            });
          }
        })
        .catch(function(error) {
          console.log(error);
        });
    }
    function tweetIndicate(tweetResult, nowDataCount, dataSize) {
      db.collection("users")
        .doc(tweetResult.userId)
        .get()
        .then(function(womanUserResult) {
          firebase
            .storage()
            .ref()
            .child("profilePicture/" + tweetResult.userId)
            .getDownloadURL()
            .then(url => {
              // 画像取得できた
              return url;
            })
            .catch(function() {
              // 画像取得できないとき
              url = "img/userSampleImageMan.png";
              return url;
            })
            .then(function(url) {
              $("#tweetImage_" + nowDataCount).attr("src", url);
              $("#tweetlist_" + nowDataCount).click(function() {
                otherPageJump(tweetResult.userId);
              });
              $("#tweetText_" + nowDataCount).html(tweetResult.tweet);
              $("#tweetTime_" + nowDataCount).html(
                jikanCulc(tweetResult.createTime)
              );
              $("#tweetUserName_" + nowDataCount).html(
                womanUserResult.data().username
              );
            })
            .catch(function(error) {
              console.log(error);
            });
        })
        .catch(function(error) {
          console.log(error);
        });
    }
    function tweetInsert() {
      showLoad();
      var tweetInputText = $("#tweetInputText").val();

      if (tweetInputText == "" || tweetInputText == null) {
        hideLoad();
        ons.notification.alert({
          message: "つぶやき内容を記入してください"
        });
      } else {
        var user = firebase.auth().currentUser;
        var userId = user.uid;
        db.collection("users")
          .doc(userId)
          .get()
          .then(function(userResult) {
            var sex = userResult.data().sex;
            return sex;
          })
          .then(function(sex) {
            db.collection("tweet")
              .doc()
              .set(
                {
                  userId: userId,
                  userSex: sex,
                  tweet: tweetInputText,
                  createTime: new Date()
                },
                { merge: true }
              )
              .then(function() {
                hideLoad();
                $("#tweetInputText").val("");
                tweetModalHide();
                ons.notification.alert({
                  message: "つぶやきました"
                });
                tweetGet($("#nowTweetPageSex").val());
              })
              .catch(function(error) {
                console.log(error);
                hideLoad();
                ons.notification.alert({
                  message: "失敗しました"
                });
              });
          })
          .catch(function(error) {
            console.log(error);
            hideLoad();
            ons.notification.alert({
              message: "失敗しました"
            });
          });
      }
    }
  </script>
</ons-page>
