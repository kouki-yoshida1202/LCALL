<ons-page id="chatDetailPage">
  <style>
    #chatDetailPage .page__background{
      background-color: white !important;
    }

    #chatCommentInput input{
      height: 40px;
    }
  </style>
  <ons-toolbar>
    <div class="left" style="padding-left:8px;">
      <ons-back-button></ons-back-button>
    </div>
    <div id="chatPartnerName"class="center" style="display: flex;justify-content: center;align-items: center;">メッセージ</div>
    <div class="right">
      <ons-toorbar-button
      id="popOverButton"
        ripple
        onclick="showChatPopover(this);"
        style="line-height: 25px;color:#ff9831;padding-right:8px;"
        >日程調整</ons-button
      >
    </div>
  </ons-toolbar>

  <div class="content" sytle="background-color:white;">
    <ons-list id="chats" style="background-image:none;padding-bottom:50px;">
    </ons-list>
  </div>
  <ons-bottom-toolbar id="chatDetailBottom" style="line-height: 40px;height:55px">
    <ons-row style="padding-top:5px;">
      <ons-col width="7%" vertical-align="center" style="text-align: end;">
        <ons-icon icon="fa-plus-circle" style="color:grey;font-size:1.2em;"
        onclick="talkOption();"
        >
      </ons-icon>
      </ons-col>
      <ons-col width="80%" style="text-align: center;font-size:1.0em;" vertical-align="center">
        <!-- <ons-input id="chatCommentInput"
          style="background-color: #efeff4;width:90%;line-height: 40px;padding-top:0px;padding-bottom:0px;"
          placeholder="コメント入力欄">
        </ons-input> -->
        <textarea id="chatCommentInput" class="textarea textarea--transparent" rows="1" placeholder="コメント入力欄"
          style="background-color: #efeff4;width:90%;height: 40px;padding-top:6px;padding-bottom:0px;"></textarea>
      </ons-col>
      <ons-col width="13%" style="text-align: center;" vertical-align="center">
        <ons-button class="large-button-orange" style="font-size:1.0em;padding-top:0px;padding-bottom:0px;line-height:40px;"
          onclick="chatSubmit()">送信
        </ons-button>
      </ons-col>
    </ons-row>
  </ons-bottom-toolbar>
  <ons-popover direction="down" id="chatPopover" cancelable>
    <div style="padding: 10px; text-align: center;">
      <ons-row>
        <ons-col
          width="100%"
          style="text-align: right;"
          vertical-align="center"
        >
          <ons-icon icon="fa-times-circle" onclick="hideChatPopover()"></ons-icon>
        </ons-col>
      </ons-row>
      <ons-row style="padding:20px 10px;">
        <ons-col width="30%" vertical-align="center">
          日時
        </ons-col>
        <ons-col vertical-align="center" width="70%" style="text-align: right;">
          <ons-input id="suggestDay" type="date" style="margin-bottom:5px;display: flex;align-items: center;"></ons-input>
          <style>
            #suggestDay input {
              display: flex;
              align-items: center;
              font-size:0.8em;
            }
          </style>
          <br>
          <ons-input id="suggestTime"type="time"></ons-input>
        </ons-col>
      </ons-row>
      <ons-row style="padding:20px 10px;">
        <ons-col vertical-align="center" width="30%">
          飲食時間
        </ons-col>
        <ons-col vertical-align="center" width="70%" style="text-align: right;">
          <ons-select id="suggestHours" onchange="editSelects(event)">
            <option></option>
            <option value="1">1時間</option>
            <option value="2">2時間</option>
            <option value="3">3時間</option>
            <option value="4">4時間</option>
          </ons-select>
        </ons-col>
      </ons-row>
      <ons-row style="padding:20px 10px;">
        <ons-col vertical-align="center" width="30%">
          合計
        </ons-col>
        <ons-col vertical-align="center" width="70%" style="text-align: right;">
          <p><span id="needPoint">0</span>P</p>
        </ons-col>
      </ons-row>
      <p style="padding:10px;">
        <ons-button
          modifier="large"
          style="border-radius: 10px;background-color:#ff9831;"
          ripple
          onclick="daySuggestCheck()"
          >日程を提案する</ons-button
        >
      </p>
      
    </div>
  </ons-popover>
  <ons-modal id="talkOption">
    <ons-card>
      <p style="text-align: center;font-size:1.2em;margin-top:0px;margin-bottom:40px;">
        <span style="float:right;padding-right:0.5em;" onclick="hideTalkOptionModal();"><i
            class="fas fa-times"></i></span>
      </p>
      <ons-button modifier="large" class="large-button-orange"onclick="talkPhoto()">
        写真を送信する
      </ons-button>
      <hr style="margin-top:50px;margin-bottom:50px;">
      <ons-button modifier="large" class="large-button-blue" onclick="getPosition()">
        位置情報を送信する
      </ons-button>
    </ons-card>
  </ons-modal>
  <input type="hidden" id="chatDetailPageUserId">
  <input type="hidden" id="chatDetailPageUserRank">
  <input type="hidden" id="chatDetailPageMessageId">
  <img id="talkPhotoZone" style="display:none;"></img>
  
  <script>
    function talkPhoto() {
        window.navigator.camera.getPicture((imageData) => {
          //成功時
          document.getElementById('talkPhotoZone').src = 'data:image/jpeg;base64,' + imageData;
          setTimeout(function () {
            alert("aiueo");
            var img = document.getElementById('talkPhotoZone');
            var dataURI = img.getAttribute('src');
            // dataURIをBlobに変換する
            alert("aiueo2");
            alert(dataURI);
            var blob = toBlob(dataURI);
            alert(blob);
            var strong = 1000;
            var uid =  new Date().getTime().toString(16) + Math.floor(strong * Math.random()).toString(16);
            firebase
              .storage()
              .ref("talkPicture/" + uid)
              .put(blob)
              .then(function(){
                firebase
                  .storage()
                  .ref("talkPicture/" + uid).getDownloadURL().then(function(downloadURL){
                    send(downloadURL);
                  });
              });
          }, 500);

        }, (error) => {
          // 失敗時
          alertNew("写真取得に失敗しました", "", "");
        }, {
          // 各種設定
          sourceType: window.navigator.camera.PictureSourceType.SAVEDPHOTOALBUM,
          destinationType: window.navigator.camera.DestinationType.DATA_URL,
          targetWidth: 800,
          targetHeight: 800
        });
      }
    function talkOption(){
      showTalkOptionModal();
    }

    function getPosition(){
      // Geolocation APIに対応している
      if (navigator.geolocation) {
        // 現在位置を取得できる場合の処理
        console.log("ok");
        navigator.geolocation.getCurrentPosition(onSuccess, onError);
      }

      // Geolocation APIに対応していない
      else {
        // 現在位置を取得できない場合の処理
        alert("あなたの端末では、現在位置を取得できません。");
      }
      
    }

    // 3. 現在地取得に成功した場合の処理
    function onSuccess(position) {
      // 4. Google Maps APIの位置情報オブジェクトを生成
      console.log(position);
      var latitude = position.coords.latitude;
      var longitude = position.coords.longitude;
      var chatText = "https://www.google.com/maps?q="+latitude+","+longitude;
      // var latlng = new google.maps.LatLng(latitude, longitude);
      // // 5. 地図を表示
      // map = new google.maps.Map(document.getElementById("mapCanvas"), {
      //   zoom: 14,       // ズームレベル
      //   center: latlng 	// 中心地を指定
      // });
      // // 6. マーカーを置く
      // var marker = new google.maps.Marker({ position: latlng, map: map });
      send(chatText);
      hideTalkOptionModal();
      alert("現在の位置情報を送信しました。");
    }
    function send(chatText){
      var catchUserId = $('#chatDetailPageUserId').val();
      var sendUserId = firebase.auth().currentUser.uid;
      var usersArray = [catchUserId, sendUserId];
      usersArray.sort();
      db.collection("message")
        .where("usersId", "==", usersArray)
        .get()
        .then(function (messageRoom) {
          if (messageRoom.size > 0) {
            // 既にチャットルームが存在する場合
            chatAddCreate(messageRoom, sendUserId, catchUserId, chatText);
          } else {
            db.collection("message")
              .add({
                usersId: usersArray,
                newestTime: new Date(),
                newestText: chatText
              })
              .then(function (setResult) {
                db.collection("message")
                  .doc(setResult.id)
                  .collection("chatContents")
                  .doc()
                  .set({
                    sendChat: sendUserId,
                    catchChat: catchUserId,
                    createTime: new Date(),
                    text: chatText,
                    suggest: false
                  }, { merge: true })
                  .then(function () {
                    $('#chatCommentInput').val("");
                  });
              })
              .catch(function (error) {
                console.log(error);
              });

          }
        })
        .then(function () {
          db.collection("users")
            .doc(sendUserId)
            .get()
            .then(function (sendUserInfo) {
              var myUserName = sendUserInfo.data().username;
              var message = myUserName + "からメッセージが届きました";
              sendPush(catchUserId, message);

              sendPushTalkMail(sendUserId, catchUserId, "message", chatText);
            });
        });
    }
    // 7. 現在地取得に失敗した場合の処理
    function onError(error) {
      console.log(error);
      alert(JSON.stringify(error));
    }

    function showTalkOptionModal() {
      var modal = document.querySelector("#talkOption");
      modal.show();
      // setTimeout(function() {
      //   modal.hide();
      // }, 2000);
    }

    function hideTalkOptionModal() {
      var modal = document.querySelector("#talkOption");
      modal.hide();
    }
    $('.chatCard').click(function(){
      console.log($(this).html());
    });
    
    setTimeout(function () {
      let chatDetailPage = document.querySelector("#chatDetailPage");
      original_main_height = chatDetailPage.clientHeight;
      var dt = new Date();
      var year = dt.getFullYear();
      var month = ("00" + (dt.getMonth() + 1)).slice(-2);
      var day = ("00" + dt.getDate()).slice(-2);
      var hours = ("00" + dt.getHours()).slice(-2);
      var minute = ("00" + dt.getMinutes()).slice(-2);
      // year + "-" + month + "-" + day + "" + hours + "" + minute);
      $('#suggestDay input').val(year+"-"+month+"-"+day);
      $('#suggestTime input').val(hours + ":" + minute);
  }, 100);
    setTimeout(function(){
      // how many milliseconds is a long press?
      var longpress = 500;
      // holds the start time
      var start;
      jQuery(".chatCard").on('mousedown', function (e) {
        start = new Date().getTime();
      });

      jQuery(".chatCard").on('mouseleave', function (e) {
        start = 0;
      });

      jQuery(".chatCard").on('mouseup', function (e) {
        if (new Date().getTime() >= (start + longpress)) { 
          window.plugins.socialsharing.share(
            $(this).text().trim()
          );
        }
      });
    },1500);
    //ソフトウェアキーボード表示処理
    window.addEventListener("keyboardWillShow", event => {
      //画面の高さをキーボードの高さを差し引いた値とする
      $("#chatDetailPage").animate(
        { height: original_main_height - event.keyboardHeight -60+ "px" },
        100
      );
    });

    //ソフトウェアキーボード非表示処理
    window.addEventListener("keyboardWillHide", () => {
      //画面の高さを元の高さに戻す
      $("#chatDetailPage").animate({ height: original_main_height + "px" }, 100);
    });

    var showChatPopover = function(target) {
      document.getElementById("chatPopover").show(target);
    };

    var hideChatPopover = function() {
      document.getElementById("chatPopover").hide();
    };

    $('#suggestHours').change(function(){
      var hour = $(this).val();
      var rank = $('#chatDetailPageUserRank').val();
      if (rank == "VIP") {
        var hourlyWage = 10000;
      } else if (rank == "プレミアム") {
        var hourlyWage = 7500;
      } else if (rank == "スタンダード") {
        var hourlyWage = 5000;
      }
      var needPoint = hourlyWage*hour;
      $('#needPoint').html(needPoint);
    });
    function daySuggestCheck(){
      ons.notification.confirm({
        message: "相手があなたの提案に承認するとポイントが引かれます。",
        title: "確認",
        buttonLabels: ["キャンセル", "確定"],
        callback: function (buttonIndex) {
          if (buttonIndex == 1) {
            daySuggest();
          }
        }
      });
    }
    function daySuggest(){
      var suggestDay = $("#suggestDay").val();
      var suggestTime= $("#suggestTime").val();
      var suggestHours = $("#suggestHours").val();

      // var suggestHours = $("#suggestHours").val();
      if(suggestDay==""||suggestDay==null||suggestTime==""||suggestTime==null|| suggestHours==""||suggestHours==null){
        ons.notification.alert({
          "message":"未入力項目があります"
        });
      }else{
        var myUserId = firebase.auth().currentUser.uid;
        db.collection("users")
          .doc(myUserId)
          .get()
          .then(function(myInfo){
            var pointNow = Number(myInfo.data().point);
            var needPoint = Number($('#needPoint').html());
            var myUserName = myInfo.data().username;
            if(needPoint>pointNow){
              ons.notification.alert({
                "message": "ポイントが足りません。マイページからチャージしてください。"
              });
            }else{
              var chatText = "日程を提案しました。<br>承認をお待ちくださいませ。<br>開始日時："+suggestDay+" "+suggestTime+"<br>"+"飲食時間："+suggestHours+"時間";
              var catchUserId = $('#chatDetailPageUserId').val();
              var sendUserId = firebase.auth().currentUser.uid;
              var usersArray = [catchUserId, sendUserId];
              usersArray.sort();
              db.collection("message")
                .where("usersId", "==", usersArray)
                .get()
                .then(function (messageRoom) {
                  var suggestDateTime = Number(suggestDay.replace(/-/g, '') + suggestTime.replace(/:/g, ''));
                  if (messageRoom.size > 0) {
                    // 既にチャットルームが存在する場合
                    messageRoom.forEach(message => {
                      var docId = message.id;
                      db.collection("message")
                        .doc(docId)
                        .collection("chatContents")
                        .doc()
                        .set({
                          sendChat: sendUserId,
                          catchChat: catchUserId,
                          createTime: new Date(),
                          text: chatText,
                          suggest: true,
                          suggestDateTime: suggestDateTime,
                          suggestHours: suggestHours,
                          status: "none",
                          needPoint: needPoint
                        }, { merge: true })
                        .then(function () {
                          db.collection("message")
                            .doc(docId)
                            .set({
                              newestTime: new Date(),
                              newestText: chatText
                            }, { merge: true })
                            .then(function () {
                              $('#chatCommentInput').val("");
                              hideChatPopover();
                            });
                        })
                        .then(function(){
                          var message = myUserName+"からメッセージが届きました";
                          sendPush(catchUserId, message);
                          
                          sendPushTalkMail(sendUserId, catchUserId,"message", chatText);
                        })
                        .catch(function (error) {
                          console.log(error);
                        });
                    });
                  } else {
                    db.collection("message")
                      .add({
                        usersId: usersArray,
                        newestTime: new Date(),
                        newestText: chatText
                      })
                      .then(function (setResult) {
                        db.collection("message")
                          .doc(setResult.id)
                          .collection("chatContents")
                          .doc()
                          .set({
                            sendChat: sendUserId,
                            catchChat: catchUserId,
                            createTime: new Date(),
                            text: chatText,
                            suggest: true,
                            suggestDateTime: suggestDateTime,
                            suggestHours:suggestHours,
                            status: "none",
                            needPoint: needPoint
                          }, { merge: true })
                          .then(function () {
                            $('#chatCommentInput').val("");
                            hideChatPopover();
                          });
                      })
                      .then(function () {
                        var message = myUserName + "からメッセージが届きました";
                        sendPush(catchUserId, message);
                        
                        sendPushTalkMail(sendUserId, catchUserId, "message",chatText);
                      })
                      .catch(function (error) {
                        console.log(error);
                      });

                  }
                });
            }
          });
      }
    }
    function chatDetailGet(){
      // showLoad();
      var chatDetailPageUserId = $('#chatDetailPageUserId').val();
      var myUserId = firebase.auth().currentUser.uid;
      var usersArray = [myUserId, chatDetailPageUserId];
      usersArray.sort();
      db.collection("message")
        .where("usersId", "==", usersArray)
        .onSnapshot(function (messages) {
          if (messages.size > 0) {
            chatIndicate(messages);
          }else{
            hideLoad();
          }
        });
    }

    function chatIndicate(messages){
      $('#chats').empty();
      var myUserId = firebase.auth().currentUser.uid;
      messages.forEach(message => {
        var messageId = message.id;
        $('#chatDetailPageMessageId').val(messageId);
        db.collection("message")
          .doc(messageId)
          .collection("chatContents")
          .orderBy("createTime", "asc")
          .get()
          .then(function (messages) {
            var nowDataCounter = 0;
            messages.forEach(message => {
              var sendChat = message.data().sendChat;
              var catchChat = message.data().catchChat;
              var text = AutoLink(message.data().text.replace(/<5060>/g, "<br>"));
              var createTime = jikanCulc(message.data().createTime);
              if (sendChat == myUserId) {
                // 自分の投稿
                var messagelist = `
                        <ons-list-item modifier="nodivider">
                          <div class="right" style="width:100%;padding-bottom:0px;justify-content:flex-end;">
                            <ons-card class="chatCard"style="background-color:#1DA1F2;color:white;margin-bottom:0px;">
                              `+ text + `
                            </ons-card>
                          </div>
                        </ons-list-item>
                        <ons-list-item modifier="nodivider">
                          <div class="center" style="min-height:0px;"></div>
                          <div class="right light-navy-font" style="margin:0px 5px;min-height:0px;width:100%;padding-top:0px;padding-bottom:0px;text-align:right;font-size:0.8em;justify-content:flex-end;">
                            `+ createTime +`
                          </div>
                        </ons-list-item>
                      `;
                $('#chats').append(messagelist);
              } else {
                // 相手の投稿
                if(message.data().suggest==false){
                  var messagelist = `
                        <ons-list-item modifier="nodivider">
                          <div class="left" style="width:100%;padding-bottom:0px;justify-content:flex-start;">
                            <ons-card class="chatCard"style="background-color:#f5f6f8;margin-bottom:0px;"
                              >
                              `+ text + `
                            </ons-card>
                          </div>
                        </ons-list-item>
                        <ons-list-item modifier="nodivider">
                          <div class="center" style="min-height:0px;"></div>
                          <div class="left light-navy-font" style="margin:0px 5px;min-height:0px;width:100%;padding-top:0px;padding-bottom:0px;text-align:left;font-size:0.8em;justify-content:flex-start;">
                            `+ createTime + `
                                              </div>
                        </ons-list-item>
                      `;
                  $('#chats').append(messagelist);
                }else{
                  var messagelist = `
                        <ons-list-item modifier="nodivider">
                          <div class="left" style="width:100%;padding-bottom:0px;justify-content:flex-start;">
                            <ons-card class="chatCard" style="background-color:#f5f6f8;margin-bottom:0px;"
                              >
                              `+ text;
                  if(message.data().status=="complete"){
                    messagelist += `
                            <ons-button
                              modifier="large"
                              class="large-button-gray"
                              style="line-height:18px;font-size:1.0em;margin-top:5px;"disabled
                              >承認済み</ons-button
                            >`;
                  }else{
                    messagelist += `
                            <ons-button
                              modifier="large"
                              class="large-button-orange"
                              onclick="suggestApprovalCheck('`+ message.id + `')"
                              style="line-height:18px;font-size:1.0em;margin-top:5px;"
                              >確認</ons-button
                            >`;
                  }
                  messagelist +=`
                            </ons-card>
                          </div>
                        </ons-list-item>
                        <ons-list-item modifier="nodivider">
                          <div class="center" style="min-height:0px;"></div>
                          <div class="left light-navy-font" style="margin:0px 5px;min-height:0px;width:100%;padding-top:0px;padding-bottom:0px;text-align:left;font-size:0.8em;justify-content:flex-start;">
                            `+ createTime + `
                                              </div>
                        </ons-list-item>
                      `;
                      $('#chats').append(messagelist);
                }
                
              }
              nowDataCounter++
              if(nowDataCounter==messages.size){
                hideLoad();
                let element = document.getElementById('chats');
                // 一番下にスクロールさせる
                element.parentElement.scrollTop = element.parentElement.scrollHeight;
              }
            });
          });
      });
    }

    function suggestApprovalCheck(messageId){
      ons.notification.confirm({
        message: "承認すると予定が確定します",
        title: "確認",
        buttonLabels: ["キャンセル", "承認"],
        callback: function (buttonIndex) {
          if (buttonIndex == 1) {
            suggestApproval(messageId);
          }
        }
      });
    }
    function suggestApproval(messageId){
      var message = $('#chatDetailPageMessageId').val();
      db.collection("message")
        .doc(message)
        .collection("chatContents")
        .doc(messageId)
        .get()
        .then(function(suggestMessage){
          var suggestDateTime = suggestMessage.data().suggestDateTime;
          var suggestHours = suggestMessage.data().suggestHours;
          var sendChatUserId = suggestMessage.data().sendChat;
          var needPoint = suggestMessage.data().needPoint;
          var startTime = String(suggestMessage.data().suggestDateTime);
          var endTime = strIns(startTime, 4, "/");
          endTime = strIns(endTime, 7, "/");
          endTime = strIns(endTime, 10, " ");
          endTime = strIns(endTime, 13, ":");
          endTime = new Date(endTime);
          endTime.setHours(endTime.getHours() + Number(suggestHours));
          endTime = Number(getCurrentTime(endTime));
          
          var text = suggestMessage.data().text;
          text = text.replace("日程を提案しました。<br>承認をお待ちくださいませ。","以下の内容で承認しました。");
          var chatText = text;
          var catchUserId = $('#chatDetailPageUserId').val();
          var sendUserId = firebase.auth().currentUser.uid;
          var usersArray = [catchUserId, sendUserId];
          usersArray.sort();
          db.collection("users")
            .doc(catchUserId)
            .get()
            .then(function (myResult) {
              var myPointNow = myResult.data().point;
              var myPointAfter = Number(myPointNow) - Number(needPoint);
              if (myPointAfter >= 0) {
                return myPointAfter;
              } else {
                ons.notification.alert({
                  message:
                    "相手の所持ポイントが足りません。"
                });
                return;
              }
            })
            .then(function(myPointAfter){
              db.collection("users")
                .doc(catchUserId)
                .set(
                  {
                    point: myPointAfter
                  },
                  { merge: true }
                )
                .then(function(){
                  db.collection("message")
                    .where("usersId", "==", usersArray)
                    .get()
                    .then(function (messageRoom) {
                      if (messageRoom.size > 0) {
                        // 既にチャットルームが存在する場合
                        messageRoom.forEach(message => {
                          var docId = message.id;
                          db.collection("message")
                            .doc(docId)
                            .collection("chatContents")
                            .doc()
                            .set({
                              sendChat: sendUserId,
                              catchChat: catchUserId,
                              createTime: new Date(),
                              text: chatText,
                              suggest: false
                            }, { merge: true })
                            .then(function () {
                              db.collection("message")
                                .doc(docId)
                                .set({
                                  newestTime: new Date(),
                                  newestText: chatText
                                }, { merge: true })
                                .then(function () {
                                  $('#chatCommentInput').val("");
                                });
                            })
                            
                            .catch(function (error) {
                              console.log(error);
                            });
                        });
                      }
                    })
                    .then(function () {
                      db.collection("message")
                        .doc(message)
                        .collection("chatContents")
                        .doc(messageId)
                        .set({
                          status: "complete"
                        }, { merge: true });
                    })
                    .then(function () {
                      db.collection("partyRoom")
                        .doc()
                        .set(
                          {
                            startTime: Number(suggestDateTime),
                            endTime: Number(endTime),
                            callNumberPeople: "2",
                            callHours: suggestHours,
                            callPlace: "チャットで相談",
                            callTime: "",
                            joinUsersId: usersArray,
                            createTime: new Date(),
                            partyStatus:"still"
                          },
                          { merge: true }
                        );
                    })
                })
                .then(function () {
                  db.collection("users")
                    .doc(sendUserId)
                    .get()
                    .then(function (sendUserInfo) {
                      var myUserName = sendUserInfo.data().username;
                      var message = myUserName + "からメッセージが届きました";
                      sendPush(catchUserId, message);
                      sendPushTalkMail(sendUserId, catchUserId, "message", chatText);
                    });
                })
                .catch(function(error){
                  console.log(error);
                });
            });
          
        });
    }
    function chatSubmit(){
      
      var chatText = $('#chatCommentInput').val()
        .replace(/\r?\n/g, "<5060>");;
      if(chatText==""||chatText==null){
        ons.notification.alert({
          "message":"未入力です"
        })
      }else{
        var catchUserId = $('#chatDetailPageUserId').val();
        var sendUserId = firebase.auth().currentUser.uid;
        var usersArray = [catchUserId,sendUserId];
        usersArray.sort();
        db.collection("message")
          .where("usersId", "==", usersArray)
          .get()
          .then(function (messageRoom) {
            if(messageRoom.size>0){
              // 既にチャットルームが存在する場合
              chatAddCreate(messageRoom, sendUserId, catchUserId, chatText);
            }else{
              db.collection("message")
                .add({
                  usersId: usersArray,
                  newestTime: new Date(),
                  newestText: chatText
                })
                .then(function (setResult) {
                  db.collection("message")
                    .doc(setResult.id)
                    .collection("chatContents")
                    .doc()
                    .set({
                      sendChat: sendUserId,
                      catchChat: catchUserId,
                      createTime: new Date(),
                      text: chatText,
                      suggest:false
                    }, { merge: true })
                    .then(function () {
                      $('#chatCommentInput').val("");
                    });
                })
                .catch(function (error) {
                  console.log(error);
                });
              
            }
          })
          .then(function () {
            db.collection("users")
              .doc(sendUserId)
              .get()
              .then(function (sendUserInfo) {
                var myUserName = sendUserInfo.data().username;
                var message = myUserName + "からメッセージが届きました";
                sendPush(catchUserId, message);
                
                sendPushTalkMail(sendUserId, catchUserId, "message", chatText);
              });
          });
        
      }
    }

    function chatAddCreate(messages,sendUserId,catchUserId,chatText){
      messages.forEach(message => {
        var docId = message.id;
        db.collection("message")
          .doc(docId)
          .collection("chatContents")
          .doc()
          .set({
            sendChat: sendUserId,
            catchChat: catchUserId,
            createTime: new Date(),
            text: chatText,
            suggest:false
          }, { merge: true })
          .then(function () {
            db.collection("message")
              .doc(docId)
              .set({
                newestTime: new Date(),
                newestText: chatText
              }, { merge: true })
              .then(function () {
                $('#chatCommentInput').val("");
              });
          })
          .catch(function (error) {
            console.log(error);
          });
      });
    }

    function sendPushTalkMail(sendUserID, catchUserID, situation,message) {
        db.collection("users")
          .doc(sendUserID)
          .get()
          .then(function (sendUserInfo) {
            var sendUserName = sendUserInfo.data().username;
            db.collection("users")
              .doc(catchUserID)
              .get()
              .then(function (catchUserInfo) {
                var catchUserMail = catchUserInfo.data().email;
                var title =
                  "【LCALL】" +
                  sendUserName +
                  "さんからメッセージが届きました。";
                var mainContent = "";
                var content =
                  "\r\n" +
                  sendUserName +
                  "さんからメッセージが届きました。\r\n\r\n<内容>\r\n"+message+"\r\n\r\n───────────────────────────────────\r\n\r\nby LCALL\r\n\r\n───────────────────────────────────\r\n";

                $.ajax({
                  type: "post",
                  url:
                    "https://www.paystripe.info/LCALL_stripe/sendPushMail.php",
                  data: {
                    email: catchUserMail,
                    title: title,
                    content: content
                  },
                  success: function (data) { }
                });
              });
          });
      }
  </script>
</ons-page>
