<ons-page id="adminlist-page">
  <style>
    .item-label {
      text-align: center;
      vertical-align: middle;
    }
    .active_tabCarousel {
      color: #ff9831;
      border-bottom: 3px solid #ff9831;
      font-weight: bold;
    }
  </style>
  <ons-toolbar>
    <div class="left">
      <ons-select class="select" id="choose-sel">
        <option value="createTime">作成日順</option>
        <option value="deadTime">期日順</option>
        <option value="title">題名順</option>
      </ons-select>
    </div>
    <div class="center">todo & SNS</div>
    <div class="right" onclick="showTestModal()">
      <ons-icon
        icon="md-plus"
        size="20px"
        style="color: red;margin-right:10%;"
      ></ons-icon>
    </div>
  </ons-toolbar>
  <div class="mainHeader">
    <ons-carousel
      id="tabCarousel"
      swipeable
      overscrollable
      auto-scroll
      var="carousel"
      item-width="50%"
      centerd
      initial-index="0"
      style="height:33px;border-bottom:1px solid #f0f0f0;padding-top:5px;font-size:0.8em;background-color: white;"
    >
      <ons-carousel-item
        class="active_tabCarousel"
        id="carousel1"
        onclick="mainTapCarouselChange(0)"
      >
        <div class="item-label">みんなのtodo</div>
      </ons-carousel-item>
      <ons-carousel-item id="carousel2" onclick="mainTapCarouselChange(1)">
        <div class="item-label">マイtodo</div>
      </ons-carousel-item>
    </ons-carousel>
  </div>
  <ons-speed-dial
    id="myPageFab"
    position="bottom right"
    direction="up"
    style="z-index: 100000 !important;"
  >
    <ons-fab modifier="mini" ripple>
      <ons-icon icon="fa-ellipsis-h"></ons-icon>
    </ons-fab>

    <ons-speed-dial-item
      onclick="myNavigator.bringPageTop('html/testpageInformation.html');"
    >
      <ons-icon
        icon="fa-info"
        style="font-size:0.8em;transform:translate(0px,-1px);"
      ></ons-icon>
    </ons-speed-dial-item>
    <ons-speed-dial-item onclick="snsShare();">
      <ons-icon
        icon="fa-share"
        style="font-size:0.8em;transform:translate(0px,-2px);"
      ></ons-icon>
    </ons-speed-dial-item>
  </ons-speed-dial>
  <ons-list id="todoList"> </ons-list>
  <ons-modal id="testModal" direction="up" animation="fade">
    <ons-card>
      <ons-icon
        icon="fa-times-circle"
        style="color:gray;float:right;font-size: 1.5em;"
        onclick="hideTestModal();"
      >
      </ons-icon>
      <div class="title"><p>みんなに公開して強制力を高めよう!!</p></div>
      <div class="content">
        <div style="text-align: center; margin-top: 30px;">
          <p>
            <style>
              #newMailaddress input,
              #newPassword input {
                border-bottom: none;
              }
            </style>
            <ons-input
              id="todoTitle"
              modifier="underbar"
              type="text"
              placeholder="todoタイトル"
              style="padding:0.7em 1.0em;width:80%;"
              float
            ></ons-input>
          </p>
          <p>
            <style>
              #newMailaddress input,
              #newPassword input {
                border-bottom: none;
              }
            </style>
            <ons-input
              id="todoDeadTime"
              modifier="underbar"
              type="Date"
              placeholder="期日"
              style="padding:0.7em 1.0em;width:80%;"
              float
            ></ons-input>
          </p>
          <p style="margin-top: 2em;margin-bottom:2rem;">
            <ons-button
              class="button--cta"
              onclick="todoCreate()"
              style="border-radius: 35px;padding:0.5em 1em;width:80%;"
              ripple
              >登録する</ons-button
            >
          </p>
        </div>
      </div>
    </ons-card>
  </ons-modal>
  <script>
    function showTestModal() {
      var modal = document.querySelector("#testModal");
      modal.show();
    }

    function hideTestModal() {
      var modal = document.querySelector("#testModal");
      modal.hide();
    }

    setTimeout(function() {
      var user = firebase.auth().currentUser;
      // todoListGet(user.uid);
      todoAllListGet();
    }, 500);

    $("#choose-sel").change(function() {
      var select = $(this).val();
      console.log(select);
    });

    function todoListGet(myUserID, orderStatus) {
      if (orderStatus == "" || orderStatus == null) {
        orderStatus = "createTime";
      }
      db.collection("todo")
        .where("userID", "==", myUserID)
        .orderBy(orderStatus, "desc")
        .onSnapshot(function(querySnapshot) {
          $("#todoList").empty();
          querySnapshot.forEach(element => {
            var list =
              `
            <ons-list-item>
            <ons-row>
            <ons-col width="85%">
            <p>題名:` +
              element.data().title +
              `</p>
            <p style="font-size:0.8em;margin:0px;">作成日:` +
              element
                .data()
                .createTime.toDate()
                .toLocaleString("ja-JP") +
              `</p>
              <p style="font-size:0.8em;margin:0px;">期日:` +
              element
                .data()
                .deadTime.toDate()
                .toLocaleString("ja-JP") +
              `</p>
              </ons-col>
            <ons-col width="15%"vertical-align="center">

              <ons-button onclick="deleteTodo('` +
              element.id +
              `')">
              削除
              </ons-button>
              </ons-col>
              </ons-row>
            </ons-list-item>
            `;
            $("#todoList").append(list);
          });
        });
    }

    function deleteTodo(todoID) {
      console.log(todoID);
      db.collection("todo")
        .doc(todoID)
        .delete();
    }

    function todoCreate() {
      var myUserID = firebase.auth().currentUser.uid;
      var title = $("#todoTitle").val();
      var todoDeadTime = $("#todoDeadTime").val();
      if (title == "" || todoDeadTime == "") {
        alert("未入力です");
      } else {
        db.collection("todo").add({
          title: title,
          createTime: new Date(),
          userID: myUserID,
          favoCount: 0,
          deadTime: new Date(todoDeadTime)
        });
        $("#todoTitle").val("");
        $("#todoDeadTime").val("");
        hideTestModal();
      }
    }

    function snsShare() {
      var myUserID = firebase.auth().currentUser.uid;
      var title = $("#todoTitle").val();
      db.collection("todo")
        .where("userID", "==", myUserID)
        .get()
        .then(function(result) {
          if (result.size > 0) {
            var taskcounter = 1;
            var taskArray = "タスクは：";
            result.forEach(task => {
              var title = task.data().title;
              taskArray += title + ",";
              if (result.size == taskcounter) {
                window.plugins.socialsharing.share(taskArray);
              } else {
                taskcounter++;
              }
            });
          }
        });
    }

    function mainTapCarouselChange(carouselIndex) {
      $("#tabCarousel ons-carousel-item").removeClass("active_tabCarousel");
      $("#tabCarousel ons-carousel-item")
        .eq(carouselIndex)
        .addClass("active_tabCarousel");
      var mainCarousel = document.getElementById("mainCarousel");
      Load();
      if (carouselIndex == 0) {
        todoAllListGet();
      } else {
        var user = firebase.auth().currentUser;
        todoListGet(user.uid);
      }
    }

    function todoAllListGet() {
      db.collection("todo")
        .orderBy("createTime", "desc")
        .onSnapshot(function(querySnapshot) {
          $("#todoList").empty();
          querySnapshot.forEach(element => {
            var list =
              `
            <ons-list-item>
            <ons-row>
            <ons-col width="90%">
            <p>題名:` +
              element.data().title +
              `</p>
            <p style="font-size:0.8em;margin:0px;">作成日:` +
              element
                .data()
                .createTime.toDate()
                .toLocaleString("ja-JP") +
              `</p>
              <p style="font-size:0.8em;margin:0px;">期日:` +
              element
                .data()
                .deadTime.toDate()
                .toLocaleString("ja-JP") +
              `</p>
              </ons-col>
              <ons-col width="10%"vertical-align="center">
                <ons-icon icon="fa-heart" style="color:pink;font-weight:bold;"onclick="favoTodo('` +
              element.id +
              `',` +
              element.data().favoCount +
              `)"></ons-icon>
                <p style="color:pink;margin:0px;">` +
              element.data().favoCount +
              `</p>
              </ons-col>
              </ons-row>
            </ons-list-item>
            `;
            $("#todoList").append(list);
          });
        });
    }

    function Load() {
      $("body").LoadingOverlay("show", {
        image: "",
        fontawesome: "fa fa-spinner fa-spin fa-small"
      });
      setTimeout(function() {
        hideLoad();
      }, 2000);
    }

    function favoTodo(todoID, favoCountNow) {
      db.collection("todo")
        .doc(todoID)
        .update({ favoCount: favoCountNow + 1 });
    }
  </script>
</ons-page>
