<ons-page id="myPage">
  <style>
    #myPageFab > ons-fab,
    #myPageFab > ons-speed-dial-item {
      background-color: #ff9831;
    }
  </style>

  <ons-speed-dial
    id="myPageFab"
    position="top right"
    direction="down"
    style="z-index: 100000 !important;"
  >
    <ons-fab modifier="mini" ripple>
      <ons-icon icon="fa-ellipsis-h"></ons-icon>
    </ons-fab>
    <ons-speed-dial-item
      onclick="myNavigator.bringPageTop('html/mypage/mypageProfileEdit.html');"
    >
      <ons-icon
        icon="fa-user-edit"
        style="font-size:0.8em;transform:translate(2px,-2px);"
      ></ons-icon>
    </ons-speed-dial-item>
    <ons-speed-dial-item
      onclick="myNavigator.bringPageTop('html/mypage/mypageImformation.html');"
    >
      <ons-icon
        icon="fa-info"
        style="font-size:0.8em;transform:translate(0px,-1px);"
      ></ons-icon>
    </ons-speed-dial-item>
    <ons-speed-dial-item onclick="logoutOpen();">
      <ons-icon
        icon="fa-sign-out-alt"
        style="font-size:0.8em;transform:translate(2px,-1px);"
      ></ons-icon>
    </ons-speed-dial-item>
  </ons-speed-dial>
  <div style="height:350px;position: relative;">
    <img
      id="myPageImage"
      src="img/userSampleImageMan.png"
      alt=""
      style="width:100%;height:350px;object-fit:cover;"
    />
    <div
      style="position: absolute;bottom:20px;left: 50%;
        transform: translateX(-50%);
        -webkit-transform: translateX(-50%);
        -ms-transform: translateX(-50%);width:90%;background-color:rgba(255, 152, 49, 0.35);font-weight: bold;height:70px;border-radius: 50px;margin:0 auto;"
      onclick="reviewPageJump(firebase.auth().currentUser.uid);"
    >
      <ons-row id="myPageReview" style="height:50px;width:90%;margin:0 auto;">
        <ons-col style="text-align: center;" vertical-align="center">
          <img src="img/starOff.png" alt="" style="height:35px;" />
        </ons-col>
        <ons-col style="text-align: center;" vertical-align="center">
          <img src="img/starOff.png" alt="" style="height:35px;" />
        </ons-col>
        <ons-col style="text-align: center;" vertical-align="center">
          <img src="img/starOff.png" alt="" style="height:35px;" />
        </ons-col>
        <ons-col style="text-align: center;" vertical-align="center">
          <img src="img/starOff.png" alt="" style="height:35px;" />
        </ons-col>
        <ons-col style="text-align: center;" vertical-align="center">
          <img src="img/starOff.png" alt="" style="height:35px;" />
        </ons-col>
      </ons-row>
      <ons-row style="width:90%;margin:0 auto;height:20px;">
        <ons-col style="text-align: center;color:white;font-size:0.8em;">
          評価コメントはコチラ >
        </ons-col>
      </ons-row>
    </div>
  </div>
  <div style="width:85%;margin:0 auto;margin-top:20px;">
    <ons-row id="myImageArray" style="height:100%;width:100%;margin:0 auto;">
    </ons-row>
  </div>
  <ons-card style="width:85%;margin:0 auto;margin-top:20px;">
    <ons-row>
      <ons-col width="70%">
        <h4><span id="myPageUserName"></span> <span id="myPageOld"></span></h4>
      </ons-col>
      <ons-col
        id="myPageRankBox"
        vertical-align="center"
        width="30%"
        style="text-align: center;background-color: #ff9831;border-radius: 10px;padding:5px 3px;"
      >
        <span id="myPageRank" style="font-size:0.8em;color:white;"> </span>
      </ons-col>
    </ons-row>
    <p id="myPageText" class="light-navy" style="font-size:0.8em;"></p>
  </ons-card>
  <ons-card style="width:85%;margin:0 auto;margin-top:20px;margin-bottom:30px;">
    <ons-list-item>
      <div class="left">
        <i class="fas fa-male fa-fw" style="color:#ff9831;"></i>
      </div>
      <div class="center navy-font">
        身長
      </div>
      <div id="myPageHeight" class="right light-navy-font"></div>
    </ons-list-item>
    <ons-list-item>
      <div class="left">
        <i class="fas fa-home fa-fw" style="color:#ff9831;"></i>
      </div>
      <div class="center navy-font">
        居住地
      </div>
      <div id="myPageAddress" class="right light-navy-font"></div>
    </ons-list-item>
    <ons-list-item>
      <div class="left">
        <i class="fas fa-map-pin fa-fw" style="color:#ff9831;"></i>
      </div>
      <div class="center navy-font">
        出身地
      </div>
      <div id="myPageBirthPlace" class="right light-navy-font"></div>
    </ons-list-item>
    <ons-list-item>
      <div class="left">
        <i class="fas fa-briefcase fa-fw" style="color:#ff9831;"></i>
      </div>
      <div class="center navy-font">
        仕事
      </div>
      <div id="myPageWork" class="right light-navy-font"></div>
    </ons-list-item>
    <ons-list-item>
      <div class="left">
        <i class="fas fa-beer fa-fw" style="color:#ff9831;"></i>
      </div>
      <div class="center navy-font">
        おさけ
      </div>
      <div id="myPageAlcohol" class="right light-navy-font"></div>
    </ons-list-item>
    <ons-list-item>
      <div class="left">
        <i class="fas fa-smoking fa-fw" style="color:#ff9831;"></i>
      </div>
      <div class="center navy-font">
        たばこ
      </div>
      <div id="myPageTobacco" class="right light-navy-font"></div>
    </ons-list-item>
    <ons-list-item>
      <div class="left">
        <i class="fas fa-microphone-alt fa-fw" style="color:#ff9831;"></i>
      </div>
      <div class="center navy-font">
        カラオケ
      </div>
      <div id="myPageKaraoke" class="right light-navy-font"></div>
    </ons-list-item>
    <ons-list-item>
      <div class="left">
        <i class="fas fa-user fa-fw" style="color:#ff9831;"></i>
      </div>
      <div class="center navy-font">
        髪型
      </div>
      <div id="myPageHairStyle" class="right light-navy-font"></div>
    </ons-list-item>
    <ons-list-item>
      <div class="left">
        <i class="fas fa-paint-brush fa-fw" style="color:#ff9831;"></i>
      </div>
      <div class="center navy-font">
        髪の色
      </div>
      <div id="myPageHairColor" class="right light-navy-font"></div>
    </ons-list-item>
  </ons-card>
  <script>
    function logoutOpen() {
      ons.notification.confirm({
        message: "ログアウトしますか？",
        title: "確認",
        buttonLabels: ["Cancel", "OK"],
        callback: function(buttonIndex) {
          if (buttonIndex == 1) {
            logout();
          }
        }
      });
    }

    function logout() {
      firebase.auth().onAuthStateChanged(user => {
        firebase
          .auth()
          .signOut()
          .then(() => {
            window.location = "index.html";
          })
          .catch(error => {
            ons.notification.alert({
              title: "ログイン失敗",
              message: `ログアウト時にエラーが発生しました (${error})`
            });
          });
      });
    }
    document.addEventListener(
      "init",
      function(event) {
        if (event.target.matches("#myPage")) {
          // コンテンツを準備...
          var user = firebase.auth().currentUser;
          if (user) {
            // User is signed in.
            userInfo(user.uid);
          }
        }
      },
      false
    );
    function myImageArray(userId, noUrl) {
      $("#myImageArray").empty();
      ref = firebase
        .storage()
        .ref()
        .child("profilePicture/" + userId + "/1")
        .getDownloadURL()
        .then(url => {
          var imageArray =
            `
                  <ons-col style="text-align: center;" vertical-align="center">
                    <img src="` +
            url +
            `" alt="" style="height:40px;width:40px;border-radius:50%;object-fit:cover;"onclick="imageChange('` +
            url +
            `','myPageImage')" />
                  </ons-col>
                `;
          $("#myImageArray").append(imageArray);
          ref = firebase
            .storage()
            .ref()
            .child("profilePicture/" + userId + "/2")
            .getDownloadURL()
            .then(url => {
              var imageArray =
                `
                  <ons-col style="text-align: center;" vertical-align="center">
                    <img src="` +
                url +
                `" alt="" style="height:40px;width:40px;border-radius:50%;object-fit:cover;"onclick="imageChange('` +
                url +
                `','myPageImage')" />
                  </ons-col>
                `;
              $("#myImageArray").append(imageArray);
              ref = firebase
                .storage()
                .ref()
                .child("profilePicture/" + userId + "/3")
                .getDownloadURL()
                .then(url => {
                  var imageArray =
                    `
                  <ons-col style="text-align: center;" vertical-align="center">
                    <img src="` +
                    url +
                    `" alt="" style="height:40px;width:40px;border-radius:50%;object-fit:cover;"
                    onclick="imageChange('` +
                    url +
                    `','myPageImage')"/>
                  </ons-col>
                `;
                  $("#myImageArray").append(imageArray);
                  ref = firebase
                    .storage()
                    .ref()
                    .child("profilePicture/" + userId + "/4")
                    .getDownloadURL()
                    .then(url => {
                      var imageArray =
                        `
                          <ons-col style="text-align: center;" vertical-align="center">
                            <img src="` +
                        url +
                        `" alt="" style="height:40px;width:40px;border-radius:50%;object-fit:cover;" onclick="imageChange('` +
                        url +
                        `','myPageImage')"/>
                          </ons-col>
                        `;
                      $("#myImageArray").append(imageArray);
                      ref = firebase
                        .storage()
                        .ref()
                        .child("profilePicture/" + userId + "/5")
                        .getDownloadURL()
                        .then(url => {
                          var imageArray =
                            `
                              <ons-col style="text-align: center;" vertical-align="center">
                                <img src="` +
                            url +
                            `" alt="" style="height:40px;width:40px;border-radius:50%;object-fit:cover;" onclick="imageChange('` +
                            url +
                            `','myPageImage')"/>
                              </ons-col>
                            `;
                          $("#myImageArray").append(imageArray);
                        });
                    });
                });
            });
        })
        .catch(function(err) {
          var imageArray =
            `
            <ons-col style="text-align: center;" vertical-align="center">
              <img src="` +
            noUrl +
            `" alt="" style="height:40px;width:40px;border-radius:50%;object-fit:cover;" />
            </ons-col>
          `;
          $("#myImageArray").append(imageArray);
        });
    }

    function imageChange(url, place) {
      document.getElementById(place).src = url;
    }
    function userInfo(userId) {
      var docRef = db.collection("users").doc(userId);

      docRef
        .get()
        .then(function(doc) {
          if (doc.exists) {
            $("#myPageUserName").html(doc.data().username);
            if (doc.data().old != "" || doc.data().old != null) {
              $("#myPageOld").html(doc.data().old + "才");
            }
            if (doc.data().sex == "woman") {
              $("#myPageRank").html(doc.data().rank);
            } else {
              $("#myPageRank").html(doc.data().point + "P所持");
            }
            $("#myPageText").html(doc.data().text);
            $("#myPageHeight").html(doc.data().height);
            $("#myPageTobacco").html(doc.data().tobacco);
            $("#myPageAddress").html(doc.data().address);
            $("#myPageAlcohol").html(doc.data().alcohol);
            $("#myPageBirthPlace").html(doc.data().birthplace);
            $("#myPageHairColor").html(doc.data().haircolor);
            $("#myPageHairStyle").html(doc.data().hairstyle);
            $("#myPageWork").html(doc.data().work);
            $("#myPageKaraoke").html(doc.data().karaoke);
            var user = firebase.auth().currentUser;
            ref = firebase
              .storage()
              .ref()
              .child("profilePicture/" + user["uid"] + "/1");
            ref
              .getDownloadURL()
              .then(url => {
                return url;
              })
              .catch(function(error) {
                if (doc.data().sex == "woman") {
                  var url = "img/userSampleImageWoman.png";
                } else {
                  var url = "img/userSampleImageMan.png";
                }
                return url;
              })
              .then(function(url) {
                document.getElementById("myPageImage").src = url;
                myImageArray(userId, url);
              });

            // var reviewInFo =
            reviewControl(userId).then(function(result) {
              $("#myPageReview").empty();
              for (var i = 1; i < 6; i++) {
                if (i > result[1]) {
                  var star =
                    '<ons-col style="text-align: center;" vertical-align="center"><img src="img/starOff.png" alt="" style="height:35px;" /></ons-col>';
                } else {
                  var star =
                    '<ons-col style="text-align: center;" vertical-align="center"><img src="img/starOn.png" alt="" style="height:35px;" /></ons-col>';
                }
                $("#myPageReview").append(star);
              }
            });
          } else {
            // doc.data() will be undefined in this case
            console.log("No such document!");
          }
        })
        .catch(function(error) {
          console.log("Error getting document:", error);
        });
    }

    function reviewPageJump(userId) {
      myNavigator.bringPageTop("html/reviewPage.html");
      setTimeout(function() {
        reviewInfomation(userId);
      }, 500);
    }
  </script>
</ons-page>
