<ons-page id="loginPage">
  <style>
    ::placeholder {
      color: white;
    }

    .cp_iptxt {
      margin: 12px 7%;
    }

    .alert-dialog-content input {
      border: 1px solid grey;
      border-radius: 5px;
      padding: 5px;
    }
  </style>
  <div
    class="content"
    style="text-align: center;background-image: url(img/login_backimage.jpg) !important;height:100% !important;background-size: cover !important;"
  >
    <div
      style="position:absolute;top:0;left:0;background-color:rgba(0,0,0,0.6);height:100%;width:100%;"
    >
      <div
        style="height:35%;display:flex;align-items: center;text-align: center;"
      >
        <img
          src="img/LCALL.png"
          alt=""
          style="width:40%;height:auto;margin:0 auto;margin-top:10%;"
        />
      </div>
      <div class="cp_iptxt">
        <input
          type="email"
          placeholder="Email"
          id="login_mailaddress"
          style="border-radius: 35px; padding:1em;padding-left:65px;border:none;background-color:rgba(255,255,255,0.3);color:white;"
        />
        <i
          class="fas fa-envelope fa-lg fa-fw"
          aria-hidden="true"
          style="padding:13px 20px;color:white;"
        ></i>
      </div>
      <div class="cp_iptxt">
        <input
          type="password"
          placeholder="Password"
          id="login_password"
          style="border-radius: 35px; padding:1em;padding-left:65px;border:none;background-color:rgba(255,255,255,0.3);color:white;"
        />
        <i
          class="fas fa-unlock-alt fa-lg fa-fw"
          aria-hidden="true"
          style="padding:13px 20px;color:white;"
        ></i>
      </div>
      <div class="cp_iptxt" style="margin-top:5px;">
        <p
          style="text-align: right;color:white;font-weight: 300;"
          onclick="showPasswordReminderModal();"
        >
          パスワードを忘れた方 >
        </p>
      </div>
      <div class="cp_iptxt" style="margin-top:5%;">
        <ons-button
          class="button--large--cta"
          style="margin: 0 auto;border-radius: 35px;padding:0.5em;background-color:#ff9831;"
          ripple
          onclick="loginCheck($('#login_mailaddress').val(),$('#login_password').val());"
        >
          Login
        </ons-button>
      </div>
      <div class="cp_iptxt">
        <p
          style="text-align:center;color:white;"
          onclick="showCreateUserModal();"
        >
          <span
            style="border-bottom:1px solid white;padding:0.5em 1em;font-weight: 300;"
          >
            アカウント登録
          </span>
        </p>
      </div>
      <div class="cp_iptxt" style="margin-top:20px;">
        <p style="text-align:center;color:white;">
          続行することにより、<span
            style="color:#0799d7;"
            onclick='window.open("https://lcall-test.web.app/riyouKiyaku.html", "_system", "usewkwebview=yes");'
            >利用規約</span
          >および<span
            style="color:#0799d7;"
            onclick='window.open("https://lcall-test.web.app/privacyPolicy.html", "_system", "usewkwebview=yes");'
            >プライバシーポリシー</span
          >に同意したものとみなされます。
        </p>
      </div>
    </div>
  </div>
  <ons-modal id="newAccountCreate" direction="up" animation="fade">
    <ons-card>
      <ons-icon
        icon="fa-times-circle"
        style="color:gray;float:right;font-size: 1.5em;"
        onclick="hideCreateUserModal();"
      ></ons-icon>
      <div class="title"></div>
      <div class="content">
        <div style="text-align: center; margin-top: 30px;">
          <p>
            <style>
              #newMailaddress input,
              #newPassword input {
                border-bottom: none;
              }
            </style>
            <ons-input
              id="newMailaddress"
              modifier="underbar"
              type="email"
              placeholder="メールアドレス"
              style="padding:0.7em 1.0em;width:80%;"
              float
            ></ons-input>
          </p>
          <p>
            <ons-input
              id="newPassword"
              modifier="underbar"
              type="password"
              placeholder="パスワード"
              style="padding:0.7em 1.0em;width:80%;"
              float
            ></ons-input>
          </p>
          <p style="margin-top: 2em;margin-bottom:2rem;">
            <ons-button
              class="button--cta"
              onclick="newUserCreate($('#newMailaddress').val(),$('#newPassword').val())"
              style="border-radius: 35px;padding:0.5em 1em;width:80%;"
              ripple
              >男性でアカウント登録する</ons-button
            >
          </p>

          <hr />
          <p style="margin-top:2rem;">
            <ons-button
              class="button--cta"
              onclick="womanUserCreatePageJump()"
              style="border-radius: 35px;padding:0.5em 1em;width:80%;background: pink"
              ripple
              >女性の登録はこちらから ></ons-button
            >
          </p>
        </div>
      </div>
    </ons-card>
  </ons-modal>
  <ons-modal id="passwordReminder" direction="up" animation="fade">
    <ons-card>
      <ons-icon
        icon="fa-times-circle"
        style="color:gray;float:right;font-size: 1.5em;"
        onclick="hidePasswordReminderModal();"
      ></ons-icon>
      <div class="title"></div>
      <div class="content">
        <div style="text-align: center; margin-top: 30px;">
          <p>
            <style>
              #updateMailaddress input {
                border-bottom: none;
              }
            </style>
            <ons-input
              id="updateMailaddress"
              modifier="underbar"
              type="email"
              placeholder="メールアドレス"
              style="padding:0.7em 1.0em;width:80%;"
              float
            ></ons-input>
          </p>
          <p style="margin-top: 2em;">
            <ons-button
              class="button--cta"
              onclick="passwordReminder($('#updateMailaddress').val())"
              style="border-radius: 35px;padding:0.5em 1em;"
              ripple
              >パスワード再設定をする</ons-button
            >
          </p>
        </div>
      </div>
    </ons-card>
  </ons-modal>
  <script>
    setTimeout(function() {
      let loginPage = document.querySelector("#loginPage");
      original_main_height = loginPage.clientHeight;
    }, 100);

    //ソフトウェアキーボード表示処理
    window.addEventListener("keyboardWillShow", event => {
      //画面の高さをキーボードの高さを差し引いた値とする
      $("#loginPage").animate(
        { height: original_main_height - event.keyboardHeight + "px" },
        100
      );
    });

    //ソフトウェアキーボード非表示処理
    window.addEventListener("keyboardWillHide", () => {
      //画面の高さを元の高さに戻す
      $("#loginPage").animate({ height: original_main_height + "px" }, 100);
    });
    function womanUserCreatePageJump() {
      ons.notification
        .prompt({
          message: "女性会員作成専用パスコードを入力してください。"
        })
        .then(function(pass) {
          if (pass == "123") {
            myNavigator.bringPageTop("html/womanUserCreatePage.html");
          } else {
            ons.notification.alert({
              message: "パスコードが違います。"
            });
          }
        });
    }
    function loginCheck(email, password) {
      showLoad();
      console.log(email, password);
      if (email == "" || email == null) {
        hideLoad();
        ons.notification.alert({
          message: "メールアドレスが未入力です"
        });
      } else if (password.trim() == "") {
        hideLoad();
        ons.notification.alert({
          message: "パスワードが未入力です。"
        });
      } else {
        var mailcheck = MailCheck(email);
        if (mailcheck) {
          firebase
            .auth()
            .setPersistence(firebase.auth.Auth.Persistence.LOCAL)
            .then(function() {
              firebase
                .auth()
                .signInWithEmailAndPassword(email, password)
                .then(function(user) {
                  if (firebase.auth().currentUser.emailVerified) {
                    // メールアドレスの認証ができている
                    // 永続性を持たせる
                    var user = firebase.auth().currentUser;
                    db.collection("users")
                      .doc(user.uid)
                      .get()
                      .then(function(user) {
                        document.addEventListener("deviceready", function() {
                          FirebasePlugin.grantPermission(function(
                            hasPermission
                          ) {
                            console.log(
                              "Permission was " +
                                (hasPermission ? "granted" : "denied")
                            );
                          });

                          // デバイストークン取得
                          FirebasePlugin.getToken(
                            function(fcmToken) {
                              console.log(fcmToken);
                              db.collection("users")
                                .doc(user.id)
                                .set({ fcmToken: fcmToken }, { merge: true })
                                .then(function() {})
                                .catch(function(error) {
                                  alert(error);
                                });
                            },
                            function(error) {
                              console.log(error);
                            }
                          );
                        });
                        if (user.data().sex == "man") {
                          myNavigator.replacePage("html/homePage.html");
                        } else if (user.data().sex == "woman") {
                          myNavigator.replacePage("html/womanHomePage.html");
                        } else {
                          ons.notification.alert({
                            title: "ログイン失敗",
                            message: "性別が取得できませんでした。"
                          });
                        }
                      });
                    hideLoad();
                  } else {
                    // メルアド認証ができていない場合
                    firebase.auth().currentUser.sendEmailVerification();
                    // もう一度メールを送信して、認証アラートを出す
                    ons.notification.alert({
                      title: "ログイン失敗",
                      message:
                        "メールアドレス認証が済んでおりません。登録したメールアドレスに認証メールが届いておりますので、ご確認ください。"
                    });
                    hideLoad();
                  }
                })
                .catch(function(error) {
                  // Handle Errors here.
                  var errorCode = error.code;
                  var errorMessage = error.message;
                  console.log(errorCode);
                  console.log(errorMessage);
                  // ...
                  ons.notification.alert({
                    title: "ログイン失敗",
                    message: "メールアドレスかパスワードが間違っております。"
                  });
                  hideLoad();
                });
            })
            .catch(function(error) {
              // Handle Errors here.
              var errorCode = error.code;
              var errorMessage = error.message;
              console.log(error);
            });
        } else {
          ons.notification.alert({
            title: "失敗",
            message: "メールアドレスの形式が正しくありません。"
          });
          hideLoad();
        }
      }
    }
    function showCreateUserModal() {
      var modal = document.querySelector("#newAccountCreate");
      modal.show();
      // setTimeout(function() {
      //   modal.hide();
      // }, 2000);
    }

    function hideCreateUserModal() {
      var modal = document.querySelector("#newAccountCreate");
      modal.hide();
    }

    function showPasswordReminderModal() {
      var modal = document.querySelector("#passwordReminder");
      modal.show();
      // setTimeout(function() {
      //   modal.hide();
      // }, 2000);
    }

    function hidePasswordReminderModal() {
      var modal = document.querySelector("#passwordReminder");
      modal.hide();
    }

    function newUserCreate(email, password) {
      if (email == "") {
        ons.notification.alert({
          message: "メールアドレスが未入力です"
        });
      } else if (password == "") {
        ons.notification.alert({
          message: "パスワードが未入力です。"
        });
      } else if (password.length < 6) {
        ons.notification.alert({
          message: "パスワードは6文字以上でお願いします"
        });
      } else {
        showLoad();
        var mailcheck = MailCheck(email);
        if (mailcheck) {
          firebase
            .auth()
            .createUserWithEmailAndPassword(email, password)
            .then(function() {
              var user = firebase.auth().currentUser;
              user
                .sendEmailVerification()
                .then(function() {
                  // Email sent.
                  db.collection("users")
                    .doc(user.uid)
                    .set(
                      {
                        username: "男性ユーザー",
                        address: "",
                        email: email,
                        alcohol: "",
                        birthplace: "",
                        haircolor: "",
                        hairstyle: "",
                        height: "",
                        old: "",
                        sex: "man",
                        text: "",
                        tobacco: "",
                        work: "",
                        rank: "",
                        salaly: 0,
                        point: 0,
                        karaoke: "",
                        ginkoukind: "普通",
                        ginkoumeigi: "",
                        ginkouname: "",
                        ginkounumber: "",
                        ginkoushiten: "",
                        createDate: formatDateYYYYMMDDHHMM(new Date()),
                        loginDate: formatDateYYYYMMDDHHMM(new Date())
                      },
                      { merge: true }
                    )
                    .then(function() {
                      hideLoad();
                      ons.notification.alert({
                        title: "メール送信",
                        message: "認証メールを送信しました。",
                        callback: function() {
                          window.location = "index.html";
                        }
                      });
                    })
                    .catch(function(error) {
                      // An error happened.
                      console.log(error);
                      hideLoad();
                    });
                })
                .catch(function(error) {
                  // An error happened.
                  hideLoad();
                });
            })
            .catch(function(error) {
              // Handle Errors here.
              var errorCode = error.code;
              var errorMessage = error.message;
              console.log(errorCode);
              console.log(errorMessage);
              ons.notification.alert({
                title: "登録失敗",
                message:
                  "アカウント登録に失敗しました。既にメールアドレスが使用されている可能性があります。"
              });
              hideLoad();
              // ...
            });
        } else {
          ons.notification.alert({
            title: "登録失敗",
            message: "メールアドレスの形式が正しくありません。"
          });
          hideLoad();
        }
      }
    }

    function passwordReminder(email) {
      showLoad();
      var auth = firebase.auth();

      auth
        .sendPasswordResetEmail(email)
        .then(function() {
          // Email sent.
          ons.notification.alert({
            title: "メール送信",
            message: "パスワード再設定メールを送信しました。ご確認ください。"
          });
          hidePasswordReminderModal();
          hideLoad();
        })
        .catch(function(error) {
          // An error happened.
          ons.notification.alert({
            title: "メール送信失敗",
            message:
              "パスワード再設定メールの送信に失敗しました。再度メールアドレスをお確かめください。"
          });
          hideLoad();
        });
    }
    // -------------------------------------------------------------------
    // メールアドレスチェック関数
    // -------------------------------------------------------------------
    function MailCheck(mail) {
      var mail_regex1 = new RegExp(
        "(?:[-!#-'*+/-9=?A-Z^-~]+\.?(?:\.[-!#-'*+/-9=?A-Z^-~]+)*|\"(?:[!#-\[\]-~]|\\\\[\x09 -~])*\")@[-!#-'*+/-9=?A-Z^-~]+(?:\.[-!#-'*+/-9=?A-Z^-~]+)*"
      );
      var mail_regex2 = new RegExp("^[^\@]+\@[^\@]+$");
      if (mail.match(mail_regex1) && mail.match(mail_regex2)) {
        // 全角チェック
        if (
          mail.match(
            /[^a-zA-Z0-9\!\"\#\$\%\&\'\(\)\=\~\|\-\^\\\@\[\;\:\]\,\.\/\\\<\>\?\_\`\{\+\*\} ]/
          )
        ) {
          return false;
        }
        // 末尾TLDチェック（〜.co,jpなどの末尾ミスチェック用）
        if (!mail.match(/\.[a-z]+$/)) {
          return false;
        }
        return true;
      } else {
        return false;
      }
    }
  </script>
</ons-page>
